<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugiyama Layout with D3.js</title>
    <script src="libs/d3.min.js"></script>
    <script src="libs/d3-shape.min.js"></script>
    <script src="libs/d3-dag.iife.min.js"></script>
    <style>
        svg {
            border: 1px solid black;
            width: 100%;
            height: 500px;
        }

        .node {
            stroke: rgba(70, 131, 180, 0.5);
            stroke-width: 0.05;
            fill: steelblue;
        }

        .edge {
            stroke: #ccc;
            stroke-width: 0.1;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .label {
            font-size: 1%;
            text-anchor: middle;
            fill: rgb(255, 255, 255);
        }
    </style>
</head>

<body>
    <h1>Layout with D3-dag.js</h1>
    <svg id="graph" width="800" height="600"></svg>

    <script>

        const stratify = d3.graphStratify();
        const graph = stratify([{ id: "parent" }, { id: "child", parentIds: ["parent"] }]);

        const layout = d3.sugiyama();
        const { width, height } = layout(graph);
        console.log("size", width, height);


        // Debug the dag
        for (const node of graph.nodes()) {
            console.log("node: ", node.data.id, node.x, node.y, node);
        }
        for (const { points } of graph.links()) {
            console.log("link point:", points);
        }

        const svg = d3.select("svg")
            .attr("viewBox", [0, 0, width, height])
            .attr("style", "max-width: 100%; height: auto;");

        var lineGenerator = d3.line()
            .x((p) => {
                console.log("p: ", p);
                return p[0];
            })
            .y((p) => p[1])
            .curve(d3.curveBasis);


        svg.append("g")
            .selectAll("line")
            .data(graph.links())
            .enter()
            .append("path")
            .attr("class", "edge")
            .attr("d", d => {
                console.log("link points for path: ", d.points);
                return lineGenerator(d.points);
            })
            .attr("fill", "none")
            .attr("stroke", "green");

        // Render nodes
        svg.append("g")
            .selectAll("circle")
            .data(graph.nodes())
            .join("circle")
            .attr("class", "node")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 0.25)
            .attr("fill", "steelblue");

        // Add labels for nodes
        svg.append("g")
            .selectAll("text")
            .data(graph.nodes())
            .join("text")
            .attr("class", "label")
            .attr("x", d => d.x)
            .attr("y", d => d.y + 0.04)
            .attr("text-anchor", "middle")
            .text(d => d.data.id);

    </script>
</body>

</html>