<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugiyama Layout with D3.js</title>
    <script src="libs/d3.min.js"></script>
    <script src="libs/d3-dag.iife.min.js"></script>
    <style>
        svg {
            border: 1px solid black;
            width: 100%;
            height: 500px;
        }

        .node {
            stroke: rgba(70, 131, 180, 0.5);
            stroke-width: 0.05;
            fill: steelblue;
        }

        .edge {
            stroke: #ccc;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .label {
            font-size: 12px;
            text-anchor: middle;
        }
    </style>
</head>

<body>
    <h1>Layout with D3-dag.js</h1>
    <svg id="graph" width="800" height="600"></svg>

    <script>

        const stratify = d3.graphStratify();
        const graph = stratify([{ id: "parent" }, { id: "child", parentIds: ["parent"] }]);

        const layout = d3.sugiyama();
        const { width, height } = layout(graph);
        console.log("size", width, height);


        // Debug the dag
        for (const node of graph.nodes()) {
            console.log("node: ", node.data.id, node.x, node.y,node);
        }
        for (const { points } of graph.links()) {
            console.log("link point:", points);
        }

        const svg = d3.select("svg")
            .attr("viewBox", [0, 0, width, height])
            .attr("style", "max-width: 100%; height: auto;");

        // Create a line generator with a curve for smooth edges
        const lineGenerator = d3.line()
            .x(d => {
                console.log("d: ", d);
                return d.source.x}
            )
            .y(d => d.source.y)
            .curve(d3.curveCatmullRom.alpha(0.5));


                    // Draw edges
        // svg.selectAll("line")
        //     .data(graph.links())
        //     .join("line")
        //     .attr("class", "edge")
        //     .attr("x1", d => d.source.x)
        //     .attr("y1", d => d.source.y)
        //     .attr("x2", d => d.target.x)
        //     .attr("y2", d => d.target.y)
        //     .attr("stroke-width", 0.1);
            
        // Render links
        svg.append("g")
            .selectAll("line")
            .data(graph.links())
            .join("line")
            .attr("class", "edge")
            .x(d => {
                console.log("d: ", d);
                return d.source.x}
            )
            .y(d => d.source.y)
            .curve(d3.curveCatmullRom.alpha(0.5))

            // .attr("d", d => lineGenerator(d))
            // .attr("d", d => {
            //     console.log("d: ", d);
            //     return d3.linkVertical()
            //     .source(d => ({ x: d.source.x, y: d.source.y }))
            //     .target(d => ({ x: d.target.x, y: d.target.y }))
            // })
            // .attr("d", ({ points }) =>
            //     d3.line()
            //         .curve(d3.curveCatmullRom)
            //         // .x(d => {
            //         //     console.log("d: ", d);	
            //         //     return d.x;
            //         // })
            //         .x(d => d.x)
            //         .y(d => d.y)
            // )
            .attr("stroke-width", 0.1);

        // Render nodes
        svg.append("g")
            .selectAll("circle")
            .data(graph.nodes())
            .join("circle")
            .attr("class", "node")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 0.25)
            .attr("fill", "steelblue");

        // Add labels for nodes
        svg.append("g")
            .selectAll("text")
            .data(graph.nodes())
            .join("text")
            .attr("class", "label")
            .attr("x", d => d.x)
            .attr("y", d => d.y - 15)
            .attr("text-anchor", "middle")
            .text(d => d.data.id)
            .attr("fill", "black")
            .attr("font-size", 12);

    </script>
</body>

</html>